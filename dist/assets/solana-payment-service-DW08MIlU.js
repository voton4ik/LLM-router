var O=Object.defineProperty;var W=(e,t,r)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var A=(e,t,r)=>W(e,typeof t!="symbol"?t+"":t,r);import{P as l,b as P,u as g,s as L,a as w,T as D,S as F,C as _,L as M,c as R}from"./index-BBHCOXS2.js";const u=new l("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");new l("TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb");const E=new l("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL");new l("So11111111111111111111111111111111111111112");new l("9pan9bMn5HatX4EJdBwg9VgCa7Uz5HL8N1m5D3NdXejP");const B=e=>{const t=e.decode.bind(e),r=e.encode.bind(e);return{decode:t,encode:r}};var h={};Object.defineProperty(h,"__esModule",{value:!0});function U(e){{const t=Buffer.from(e);t.reverse();const r=t.toString("hex");return r.length===0?BigInt(0):BigInt(`0x${r}`)}}var G=h.toBigIntLE=U;function H(e){{const t=e.toString("hex");return t.length===0?BigInt(0):BigInt(`0x${t}`)}}h.toBigIntBE=H;function V(e,t){{const r=e.toString(16),n=Buffer.from(r.padStart(t*2,"0").slice(0,t*2),"hex");return n.reverse(),n}}var q=h.toBufferLE=V;function K(e,t){{const r=e.toString(16);return Buffer.from(r.padStart(t*2,"0").slice(0,t*2),"hex")}}h.toBufferBE=K;const J=e=>t=>{const r=P(e,t),{encode:n,decode:i}=B(r),a=r;return a.decode=(o,s)=>{const c=i(o,s);return G(Buffer.from(c))},a.encode=(o,s,c)=>{const f=q(o,e);return n(f,s,c)},a},N=J(8),j=e=>{const t=g(e),{encode:r,decode:n}=B(t),i=t;return i.decode=(a,o)=>!!n(a,o),i.encode=(a,o,s)=>{const c=Number(a);return r(c,o,s)},i},C=e=>{const t=P(32,e),{encode:r,decode:n}=B(t),i=t;return i.decode=(a,o)=>{const s=n(a,o);return new l(s)},i.encode=(a,o,s)=>{const c=a.toBuffer();return r(c,o,s)},i};class X extends Error{constructor(t){super(t)}}class Z extends X{constructor(){super(...arguments),this.name="TokenOwnerOffCurveError"}}var S;(function(e){e[e.InitializeMint=0]="InitializeMint",e[e.InitializeAccount=1]="InitializeAccount",e[e.InitializeMultisig=2]="InitializeMultisig",e[e.Transfer=3]="Transfer",e[e.Approve=4]="Approve",e[e.Revoke=5]="Revoke",e[e.SetAuthority=6]="SetAuthority",e[e.MintTo=7]="MintTo",e[e.Burn=8]="Burn",e[e.CloseAccount=9]="CloseAccount",e[e.FreezeAccount=10]="FreezeAccount",e[e.ThawAccount=11]="ThawAccount",e[e.TransferChecked=12]="TransferChecked",e[e.ApproveChecked=13]="ApproveChecked",e[e.MintToChecked=14]="MintToChecked",e[e.BurnChecked=15]="BurnChecked",e[e.InitializeAccount2=16]="InitializeAccount2",e[e.SyncNative=17]="SyncNative",e[e.InitializeAccount3=18]="InitializeAccount3",e[e.InitializeMultisig2=19]="InitializeMultisig2",e[e.InitializeMint2=20]="InitializeMint2",e[e.GetAccountDataSize=21]="GetAccountDataSize",e[e.InitializeImmutableOwner=22]="InitializeImmutableOwner",e[e.AmountToUiAmount=23]="AmountToUiAmount",e[e.UiAmountToAmount=24]="UiAmountToAmount",e[e.InitializeMintCloseAuthority=25]="InitializeMintCloseAuthority",e[e.TransferFeeExtension=26]="TransferFeeExtension",e[e.ConfidentialTransferExtension=27]="ConfidentialTransferExtension",e[e.DefaultAccountStateExtension=28]="DefaultAccountStateExtension",e[e.Reallocate=29]="Reallocate",e[e.MemoTransferExtension=30]="MemoTransferExtension",e[e.CreateNativeMint=31]="CreateNativeMint",e[e.InitializeNonTransferableMint=32]="InitializeNonTransferableMint",e[e.InterestBearingMintExtension=33]="InterestBearingMintExtension",e[e.CpiGuardExtension=34]="CpiGuardExtension",e[e.InitializePermanentDelegate=35]="InitializePermanentDelegate",e[e.TransferHookExtension=36]="TransferHookExtension",e[e.MetadataPointerExtension=39]="MetadataPointerExtension"})(S||(S={}));function Q(e,t,r){if(r.length){e.push({pubkey:t,isSigner:!1,isWritable:!1});for(const n of r)e.push({pubkey:n instanceof l?n:n.publicKey,isSigner:!0,isWritable:!1})}else e.push({pubkey:t,isSigner:!0,isWritable:!1});return e}const $=L([w("mintAuthorityOption"),C("mintAuthority"),N("supply"),g("decimals"),j("isInitialized"),w("freezeAuthorityOption"),C("freezeAuthority")]);$.span;async function y(e,t,r=!1,n=u,i=E){if(!r&&!l.isOnCurve(t.toBuffer()))throw new Z;const[a]=await l.findProgramAddress([t.toBuffer(),n.toBuffer(),e.toBuffer()],i);return a}const v=L([g("instruction"),N("amount"),g("decimals")]);function T(e,t,r,n,i,a,o=[],s=u){const c=Q([{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0}],n,o),f=Buffer.alloc(v.span);return v.encode({instruction:S.TransferChecked,amount:BigInt(i),decimals:a},f),new D({keys:c,programId:s,data:f})}function Y(e,t,r,n,i=u,a=E){return I(e,t,r,n,Buffer.alloc(0),i,a)}function I(e,t,r,n,i,a=u,o=E){const s=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:F.programId,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1}];return new D({keys:s,programId:o,data:i})}const x="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",z=6,k="USAisa5xaM2R9CrDcVZ3vhcgqvhumjMHVfE8Ezpu8DB",ee="https://mainnet.helius-rpc.com/?api-key=41b250dc-228f-46f2-8f23-ecd8810c8ef5",te="wss://mainnet.helius-rpc.com/?api-key=41b250dc-228f-46f2-8f23-ecd8810c8ef5";class re{constructor(){A(this,"connection");A(this,"usdcMint");A(this,"treasuryWallet");this.connection=new _(ee,{commitment:"confirmed",wsEndpoint:te}),this.usdcMint=new l(x),this.treasuryWallet=new l(k)}async getUSDCBalance(t){try{const r=new l(t),n=await y(this.usdcMint,r,!1,u),i=await this.connection.getTokenAccountBalance(n);return i.value.uiAmount?i.value.uiAmount:0}catch(r){return console.error("Error getting USDC balance:",r),0}}async createUSDCTransferTransaction(t,r){const n=new l(t),i=await y(this.usdcMint,n,!1,u),a=await y(this.usdcMint,this.treasuryWallet,!1,u),o=new R;if(!await this.connection.getAccountInfo(a)){const m=Y(n,a,this.treasuryWallet,this.usdcMint,u);o.add(m)}const c=Math.floor(r*Math.pow(10,z)),f=T(i,this.usdcMint,a,n,c,z,[],u);o.add(f);const{blockhash:d,lastValidBlockHeight:p}=await this.connection.getLatestBlockhash("confirmed");return o.recentBlockhash=d,o.feePayer=n,o}async verifyTransaction(t){try{const r=await this.connection.confirmTransaction(t,"confirmed");if(r.value.err)return{confirmed:!1,error:`Transaction failed: ${JSON.stringify(r.value.err)}`};const n=await this.connection.getParsedTransaction(t,{commitment:"confirmed",maxSupportedTransactionVersion:0});if(!n||!n.meta)return{confirmed:!1,error:"Transaction not found or no metadata"};const i=n.meta.postTokenBalances||[],a=n.meta.preTokenBalances||[];let o=0,s="",c="";for(let f=0;f<i.length;f++){const d=i[f],p=a.find(m=>m.accountIndex===d.accountIndex);if(d.mint===x&&p){const m=parseFloat(p.uiTokenAmount.uiAmountString||"0"),b=parseFloat(d.uiTokenAmount.uiAmountString||"0")-m;b>0?(o=b,c=d.owner||""):b<0&&(s=d.owner||"")}}return{confirmed:!0,amount:o,from:s,to:c}}catch(r){return console.error("Error verifying transaction:",r),{confirmed:!1,error:r instanceof Error?r.message:"Unknown error"}}}calculatePaymentAmount(t,r){const n=t*r;return Math.ceil(n*1e6)/1e6}async subscribeToTransaction(t,r){return this.connection.onSignature(t,(i,a)=>{i.err?r(!1,JSON.stringify(i.err)):r(!0)},"confirmed")}async unsubscribeFromTransaction(t){await this.connection.removeSignatureListener(t)}async estimateTransactionFee(){try{const t=await this.connection.getRecentPrioritizationFees();if(t.length===0)return 5e-6;const r=t.map(a=>a.prioritizationFee).sort((a,o)=>a-o);return(5e3+r[Math.floor(r.length/2)])/M}catch(t){return console.error("Error estimating fee:",t),5e-6}}async hasSufficientSOLForFees(t){try{const r=new l(t),i=await this.connection.getBalance(r)/M,a=await this.estimateTransactionFee();return i>=a*2}catch(r){return console.error("Error checking SOL balance:",r),!1}}async getConnectionHealth(){try{const t=await this.connection.getSlot("confirmed"),r=await this.connection.getBlockTime(t);return{healthy:!0,slot:t,blockTime:r||void 0}}catch(t){return{healthy:!1,error:t instanceof Error?t.message:"Unknown error"}}}}const oe=new re;export{re as SolanaPaymentService,oe as solanaPaymentService};
